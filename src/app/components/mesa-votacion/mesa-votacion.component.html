<!-- Overlay para unirse a partida -->
<section *ngIf="mostrarUnirseOverlay" class="overlay-unirse">
  <app-unirse-partida (cerrar)="cerrarOverlay()"></app-unirse-partida>
</section>

<!-- Barra superior derecha con logo usuario + bot√≥n de puntaje + bot√≥n invitar -->
<div class="barra-superior-derecha">
  <button class="boton-ojito" (click)="abrirModalModo()">üëÅ</button>
  <button class="boton-cambio-puntaje" (click)="abrirModalPuntaje()">
    <img src="assets/repeat.png" alt="Cambiar modo de puntaje" />
  </button>

  <div class="avatar-usuario">
    {{ usuarioActual?.nombre?.slice(0, 2) | uppercase }}
  </div>

  <button class="boton-invitar" (click)="abrirModalInvitacion()">Invitar jugadores</button>
</div>


<!-- Contenido principal si no est√° el overlay activo -->
<main class="fondo-translucido" *ngIf="!mostrarUnirseOverlay">
<!-- Logo fijo en la esquina superior izquierda -->
<header class="encabezado-superior">
  <img src="assets/logopragma.png" alt="Logo Pragma" class="logo-encabezado" />
</header>

<!-- Modal de invitaci√≥n -->
<div class="modal-invitacion-overlay" *ngIf="mostrarModalInvitacion">
  <div class="modal-invitacion">
    <div class="modal-header">
      <span>Invitar jugadores</span>
      <button class="cerrar-modal" (click)="cerrarModalInvitacion()">‚úï</button>
    </div>
    <div class="modal-cuerpo">
      <input type="text" [value]="linkDeInvitacion" readonly />
      <button (click)="copiarAlPortapapeles()">Copiar link</button>
    </div>
    <div *ngIf="mensajeCopiado" class="mensaje-copiado">¬°Link copiado exitosamente!</div>
  </div>
</div>
<!-- Modal de cambio de modo de visualizaci√≥n -->

<!-- Modal de cambio de modo de visualizaci√≥n -->
<div class="modal-modo-overlay" *ngIf="mostrarModalModo">
  <div class="modal-modo">
    <div class="modal-titulo">Cambiar modo visualizaci√≥n</div>

    <div class="opciones-modo">
      <label>
        Jugador
        <input type="radio" name="modo" value="jugador" [(ngModel)]="modoTemporal" />
        <span class="radio-custom"></span>
      </label>
      <label>
        Espectador
        <input type="radio" name="modo" value="espectador" [(ngModel)]="modoTemporal" />
        <span class="radio-custom"></span>
      </label>
    </div>

    <button class="modal-continuar" (click)="aceptarCambioModo()">Continuar</button>
  </div>
</div>


  <!-- Encabezado -->
  <header>
    <h1 class="nombre-partida-header">

      {{ nombrePartida || 'Sin nombre' }}
    </h1>
  </header>


<!-- Modal para cambiar modo de puntaje -->
<!-- Modal para cambiar modo de puntaje -->
<div class="modal-invitacion-overlay" *ngIf="mostrarModalPuntaje">
  <div class="modal-invitacion modal-puntaje">
    <div class="modal-header-puntaje">
      Cambiar modo de puntaje de las tarjetas
    </div>
    <div class="modal-cuerpo-puntaje">
      <select class="select-puntaje" [(ngModel)]="modoTemporalPuntaje">
        <option *ngFor="let modo of modosDePuntaje" [ngValue]="modo">
          {{ modo.nombre }} ({{ modo.valores.join(', ') }})
        </option>
      </select>

      <div class="botones-modal-puntaje">
        <button class="boton-cancelar-puntaje" (click)="cerrarModalPuntaje()">Cancelar</button>
        <button class="boton-aceptar-puntaje" (click)="aceptarCambioPuntaje()">Aceptar</button>
      </div>
    </div>
  </div>
</div>


  <!-- Mesa visual -->
  <section class="mesa-ovalada">
    <div class="mesa-anillo anillo-externo"></div>
    <div class="mesa-anillo anillo-medio"></div>
    <div class="mesa-anillo anillo-interno"></div>
    <div *ngIf="esAdministrador" class="boton-central">
      <button *ngIf="!cartasReveladas && !mostrandoCarga" class="boton-revelar" (click)="revelarCartas()">
        Revelar Cartas
      </button>
      
      <div *ngIf="mostrandoCarga" class="cargando-votos">
        <div class="loader-circulos">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
        <p>Contando votos</p>
      </div>
      
      <button *ngIf="cartasReveladas" class="boton-next" (click)="siguienteRonda()">Nueva votaci√≥n </button>
    </div>
  </section>

  <div class="jugador-central">
    <div
      class="carta"
      [ngClass]="{
        'carta-seleccionada': getCartaSeleccionadaActual() && !cartasReveladas,
        'revelada-animacion': cartasReveladas && getCartaSeleccionadaActual(),
        'carta-vacia': !getCartaSeleccionadaActual() && !cartasReveladas,
        'carta-vacia-revelada': !getCartaSeleccionadaActual() && cartasReveladas
      }"
    >
      <ng-container *ngIf="cartasReveladas && getCartaSeleccionadaActual()">
        {{ getCartaSeleccionadaActual() }}
      </ng-container>
      <ng-container *ngIf="!getCartaSeleccionadaActual() && cartasReveladas">
        <span class="icono-oculto"></span>
      </ng-container>
    </div>
    <div class="nombre">{{ usuarioActual?.nombre }}</div>
  </div>
  
  
  
  <!-- Acciones del usuario -->
  <section class="acciones" *ngIf="usuarioActual">
    <ng-container *ngIf="esAdministrador">
      <div class="botones-admin animar">
      </div>
    </ng-container>

    <div *ngIf="usuarioActual.modo === 'espectador'" class="mensaje-error">
      Est√°s en modo espectador. No puedes elegir cartas.
    </div>

    <app-elegir-carta
    *ngIf="usuarioActual.modo === 'jugador' && !cartasReveladas "
    [cartas]="cartasDisponibles"
    (cartaSeleccionadaEvent)="cargarJugadores()">
  </app-elegir-carta>
  

  <!-- Resultados -->
  <section *ngIf="cartasReveladas && !mostrandoCarga" class="resultado-final">
    <div class="cartas-votadas">
      <div *ngFor="let carta of cartasConVotos" class="contenedor-carta-votada">
        <div class="carta-votada">
          <div class="valor">{{ carta }}</div>
        </div>
        <div class="votos">
          {{ votosPorCarta[carta] }} {{ votosPorCarta[carta] === 1 ? 'Voto' : 'Votos' }}
        </div>
      </div>
    </div>
    <div class="promedio-final">
      <div class="etiqueta">Promedio:</div>
      <div class="valor-promedio">
        <strong *ngIf="promedioVotos !== null; else sinPromedio">
          {{ promedioVotos }}
        </strong>
        <ng-template #sinPromedio>
          <strong>No disponible</strong>
        </ng-template>
      </div>
    </div>
    
  <!-- Plantilla para jugador (reutilizable) -->
  <ng-template #jugadorTemplate let-jugador="jugador">
    <div class="jugador" [ngClass]="{ 'espectador': jugador.modo === 'espectador' }">
      <div class="nombre">
        {{ jugador.nombre }}
        <span *ngIf="jugador.nombre === usuarioAdministrador?.nombre" title="Administrador">üëë</span>
      </div>

      <button *ngIf="esAdministrador && jugador.nombre !== usuarioAdministrador?.nombre"
              class="asignar-admin" (click)="asignarAdministrador(jugador)">
        üëë Hacer Admin
      </button>

      <div class="carta" [ngClass]="{
          'oculta': jugador.modo === 'jugador' && !jugador.carta,
          'espectador-carta': jugador.modo === 'espectador',
          'revelada-animacion': cartasReveladas,
          'rellena': jugador.carta !== null && jugador.carta !== undefined
        }">
        <ng-container *ngIf="cartasReveladas || jugador.modo === 'espectador'; else cartaOculta">
          <span *ngIf="jugador.modo !== 'espectador'; else cartaEspectador">{{ jugador.carta ?? '‚Äî' }}</span>
        </ng-container>
        <ng-template #cartaOculta><span class="icono-oculto">üíä</span></ng-template>
        <ng-template #cartaEspectador><span class="icono-oculto">üìπ</span></ng-template>
      </div>
    </div>
  </ng-template>


