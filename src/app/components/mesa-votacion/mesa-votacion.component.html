<div *ngIf="mostrarUnirseOverlay" class="overlay-unirse">
  <app-unirse-partida (cerrar)="cerrarOverlay()"></app-unirse-partida>
</div>

<div class="fondo-translucido" *ngIf="!mostrarUnirseOverlay">
  <div class="acciones">
    <div class="link-invitacion">
      <label for="link-invitacion">Invitar participantes:</label>
      <div class="contenedor-link">
        <input id="link-invitacion" type="text" [value]="linkDeInvitacion" readonly />
        <button (click)="copiarAlPortapapeles()">Copiar Link</button>
      </div>
    </div>
  </div>


  <header>
    <h1>Mesa de Votación</h1>
    <div class="nombre-partida-header">
      Partida: <strong>{{ nombrePartida || 'Sin nombre' }}</strong>
    </div>
  </header>

  <div *ngIf="esAdministrador && !cartasReveladas" class="modo-puntaje-panel">
    <label for="modoPuntaje">🎯Modo de puntaje:</label>
    <select id="modoPuntaje" [(ngModel)]="modoSeleccionado" (change)="cambiarModoDePuntaje()">
      <option *ngFor="let modo of modosDePuntaje" [ngValue]="modo">🎴{{ modo.nombre }}</option>
    </select>
  </div>

  <!-- NUEVA TARJETA DE CAMBIO DE MODO -->
  <div class="modo-panel">
    <div class="modo-panel-select">
      <label for="modo">Modo de visualización:</label>
      <select id="modo" [(ngModel)]="usuarioActual.modo" (change)="cambiarModo(usuarioActual.modo)">
        <option value="jugador"> 👉🏼Jugador 👈🏼</option>
        <option value="espectador">👉🏼 Espectador 👈🏼</option>
      </select>
  
      <label class="switch">
        <input type="checkbox" [checked]="usuarioActual?.modo === 'jugador'" disabled />
        <span class="slider">
          <span class="text-on">🎮</span>
          <span class="text-off">👀</span>
        </span>
      </label>
    </div>
  </div>
  

  <section class="mesa-scroll">
    <div class="mesa-visual">
      <!-- Fila superior -->
      <div class="fila fila-superior">
        <ng-container *ngFor="let jugador of jugadores.slice(0, jugadores.length / 4)">
          <div class="jugador" [ngClass]="{ 'espectador': jugador.modo === 'espectador' }">
            <img class="avatar" [src]="jugador.avatarUrl" alt="Avatar"
              (error)="jugador.avatarUrl = 'assets/avatars/logo1.jpg'" />
            <div class="nombre">
              {{ jugador.nombre }}
              <span *ngIf="jugador.nombre === usuarioAdministrador?.nombre" title="Administrador">👑</span>
            </div>

            <!-- Botón para asignar nuevo administrador -->
            <button *ngIf="esAdministrador && jugador.nombre !== usuarioAdministrador?.nombre" class="asignar-admin"
              (click)="asignarAdministrador(jugador)">
              👑 Hacer Admin
            </button>

            <div class="carta" [ngClass]="{
                'oculta': jugador.modo === 'jugador' && !jugador.carta,
                'espectador-carta': jugador.modo === 'espectador',
                'revelada-animacion': cartasReveladas,
                'rellena': jugador.carta !== null && jugador.carta !== undefined
              }">
              <ng-container *ngIf="cartasReveladas || jugador.modo === 'espectador'; else cartaOculta">
                <span *ngIf="jugador.modo !== 'espectador'; else cartaEspectador">{{ jugador.carta ?? '—' }}</span>
              </ng-container>
              <ng-template #cartaOculta><span class="icono-oculto">💊</span></ng-template>
              <ng-template #cartaEspectador><span class="icono-oculto">📹</span></ng-template>
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Fila central -->
      <div class="fila fila-central">
        <div class="columna columna-izquierda">
          <ng-container *ngFor="let jugador of jugadores.slice(jugadores.length / 4, jugadores.length / 2)">
            <div class="jugador" [ngClass]="{ 'espectador': jugador.modo === 'espectador' }">
              <img class="avatar" [src]="jugador.avatarUrl" alt="Avatar"
                (error)="jugador.avatarUrl = 'assets/avatars/logo1.jpg'" />
              <div class="nombre">
                {{ jugador.nombre }}
                <span *ngIf="jugador.nombre === usuarioAdministrador?.nombre" title="Administrador">👑</span>
              </div>

              <!-- Botón para asignar nuevo administrador -->
              <button *ngIf="esAdministrador && jugador.nombre !== usuarioAdministrador?.nombre" class="asignar-admin"
                (click)="asignarAdministrador(jugador)">
                👑 Hacer Admin
              </button>

              <div class="carta" [ngClass]="{
                  'oculta': jugador.modo === 'jugador' && !jugador.carta,
                  'espectador-carta': jugador.modo === 'espectador',
                  'revelada-animacion': cartasReveladas,
                  'rellena': jugador.carta !== null && jugador.carta !== undefined
                }">
                <ng-container *ngIf="cartasReveladas || jugador.modo === 'espectador'; else cartaOculta">
                  <span *ngIf="jugador.modo !== 'espectador'; else cartaEspectador">{{ jugador.carta ?? '—' }}</span>
                </ng-container>
                <ng-template #cartaOculta><span class="icono-oculto">💊</span></ng-template>
                <ng-template #cartaEspectador><span class="icono-oculto">📹</span></ng-template>
              </div>
            </div>
          </ng-container>
        </div>

        <div class="rectangulo-mesa">
          <span class="mesa-texto">MESA</span>
        </div>

        <div class="columna columna-derecha">
          <ng-container *ngFor="let jugador of jugadores.slice(jugadores.length / 2, jugadores.length * 0.75)">
            <div class="jugador" [ngClass]="{ 'espectador': jugador.modo === 'espectador' }">
              <img class="avatar" [src]="jugador.avatarUrl" alt="Avatar"
                (error)="jugador.avatarUrl = 'assets/avatars/logo1.jpg'" />
              <div class="nombre">
                {{ jugador.nombre }}
                <span *ngIf="jugador.nombre === usuarioAdministrador?.nombre" title="Administrador">👑</span>
              </div>

              <!-- Botón para asignar nuevo administrador -->
              <button *ngIf="esAdministrador && jugador.nombre !== usuarioAdministrador?.nombre" class="asignar-admin"
                (click)="asignarAdministrador(jugador)">
                👑 Hacer Admin
              </button>

              <div class="carta" [ngClass]="{
                  'oculta': jugador.modo === 'jugador' && !jugador.carta,
                  'espectador-carta': jugador.modo === 'espectador',
                  'revelada-animacion': cartasReveladas,
                  'rellena': jugador.carta !== null && jugador.carta !== undefined
                }">
                <ng-container *ngIf="cartasReveladas || jugador.modo === 'espectador'; else cartaOculta">
                  <span *ngIf="jugador.modo !== 'espectador'; else cartaEspectador">{{ jugador.carta ?? '—' }}</span>
                </ng-container>
                <ng-template #cartaOculta><span class="icono-oculto">💊</span></ng-template>
                <ng-template #cartaEspectador><span class="icono-oculto">📹</span></ng-template>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Fila inferior -->
      <div class="fila fila-inferior">
        <ng-container *ngFor="let jugador of jugadores.slice(jugadores.length * 0.75)">
          <div class="jugador" [ngClass]="{ 'espectador': jugador.modo === 'espectador' }">
            <img class="avatar" [src]="jugador.avatarUrl" alt="Avatar"
              (error)="jugador.avatarUrl = 'assets/avatars/logo1.jpg'" />
            <div class="nombre">
              {{ jugador.nombre }}
              <span *ngIf="jugador.nombre === usuarioAdministrador?.nombre" title="Administrador">👑</span>
            </div>

            <!-- Botón para asignar nuevo administrador -->
            <button *ngIf="esAdministrador && jugador.nombre !== usuarioAdministrador?.nombre" class="asignar-admin"
              (click)="asignarAdministrador(jugador)">
              👑 Hacer Admin
            </button>

            <div class="carta" [ngClass]="{
                'oculta': jugador.modo === 'jugador' && !jugador.carta,
                'espectador-carta': jugador.modo === 'espectador',
                'revelada-animacion': cartasReveladas,
                'rellena': jugador.carta !== null && jugador.carta !== undefined
              }">
              <ng-container *ngIf="cartasReveladas || jugador.modo === 'espectador'; else cartaOculta">
                <span *ngIf="jugador.modo !== 'espectador'; else cartaEspectador">{{ jugador.carta ?? '—' }}</span>
              </ng-container>
              <ng-template #cartaOculta><span class="icono-oculto">💊</span></ng-template>
              <ng-template #cartaEspectador><span class="icono-oculto">📹</span></ng-template>
            </div>
          </div>
        </ng-container>
      </div>

    </div>
  </section>

  <!-- Acciones (botones, cambio de modo, elegir carta) -->
  <section class="acciones" *ngIf="usuarioActual">
    <ng-container *ngIf="esAdministrador">
      <div class="botones-admin animar">
        <button class="boton-next" (click)="siguienteRonda()">NEXT ROUND →</button>
        <button *ngIf="!cartasReveladas" class="boton-next" (click)="revelarCartas()">REVELAR CARTAS 👁</button>
        <button *ngIf="cartasReveladas" class="boton-next cerrar" (click)="cerrarRevelacion()">OCULTAR CARTAS
          🙈</button>
      </div>
    </ng-container>

    <div *ngIf="usuarioActual.modo === 'espectador'" class="mensaje-error">
      Estás en modo espectador. No puedes elegir cartas.
    </div>

    <app-elegir-carta *ngIf="usuarioActual.modo === 'jugador'" [cartas]="cartasDisponibles"
      (cartaSeleccionadaEvent)="cargarJugadores()">
    </app-elegir-carta>
  </section>

  <section *ngIf="cartasReveladas" class="resultados">
    <h3>Resultados</h3>
    <div *ngIf="cartasConVotos.length === 0" class="mensaje-sin-votos animacion-votos">
      <span class="emoji">😬</span> Nadie ha votado todavía.
    </div>
    <ul *ngIf="cartasConVotos.length > 0">
      <li *ngFor="let carta of cartasConVotos">
        Carta {{ carta }}: {{ votosPorCarta[carta] }} voto(s)
      </li>
    </ul>
    <div class="promedio">
      Promedio:
      <span *ngIf="promedioVotos !== null; else sinPromedio">
        {{ promedioVotos }}
      </span>
      <ng-template #sinPromedio>No disponible...Elegiste ☕</ng-template>
    </div>
  </section>
</div>